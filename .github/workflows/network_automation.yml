name: Network Automation

on:
  push:
    branches: [ "main" ]
    paths:
      - 'ansible/**'
      - '.github/workflows/network_automation.yml'

jobs:
  configure-network:
    runs-on: self-hosted

    steps:
      - name: Check out repo
        uses: actions/checkout@v3

      - name: Install ansible
        run: |
          sudo apt-get update && sudo apt-get install -y ansible
          
      - name: Run Ansible Playbook
        env:
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
          TOKEN: ${{ secrets.PAT }}
          ANSIBLE_HOST_KEY_CHECKING: False
        run: |
          ansible-playbook /etc/ansible/ansible/configure_devices.yml -i /etc/ansible/ansible/inventory.ini --extra-vars "ansible_user=${USERNAME} ansible_password=${PASSWORD}"

      - name: Move backup files to Git-tracked directory
        run: |
          mkdir -p ansible/backups
          sudo cp /etc/ansible/backups/*.txt ansible/backups/  # Move backups into the repo

      - name: Commit and Push Backup
        run: |
          git config --global user.name "Syed"
          git config --global user.email "ali431@sheridancollege.ca"
          git add ansible/backups
          if ! git diff --cached --quiet; then
            git commit -m "Automated running-config backup commit"
            git push
          else
            echo "No changes to commit"
          fi



